//yecha编写 Q:372009617

var min=0.1; //打赏最小范围
var max=500; //打赏最大范围

$(function(){
	gaoliang(); //菜单高亮
	//首页幻灯
	if($(".hdpic").length>0){
		jQuery(".focusBox").slide({ titCell:".num", mainCell:".pic",effect:"fold", autoPlay:true,autoPage:true,trigger:"click",startFun:function(i){jQuery(".focusBox .txt li").eq(i).animate({"bottom":0}).siblings().animate({"bottom":-36});}});	
	}
	$(".topsrh").click(function(){
    $(".search-form").submit();
	});
  //列表页设置宽度
  if($(".newslist").length>0){
    $(".newslist li").each(function(){
      if($(this).find(".newspic").length){} else {$(this).find(".newsxx").css("width","100%");};
    });
  }
  if($(".xxpiclist").length>0){
    $(".xxpiclist li").each(function(){
      if($(this).find(".newspic").length){} else {$(this).find(".newsxx").css("width","100%");}
    });
  }
	//分享
	$(".ne-shares-parent").hover(function(){
		$(this).addClass("ne-shares-open");
	},function(){
		$(this).removeClass("ne-shares-open");	
	});
	$(".ne-shares-parent").click(function(){
		$(this).toggleClass("ne-shares-open");	
	});
	$(".ne-shares-weixin").hover(function(){
		$(this).parent().parent().parent().parent().find(".ne-shares-qrwrap").show();
	},function(){
		$(this).parent().parent().parent().parent().find(".ne-shares-qrwrap").hide();	
	});
	$(".showewm").hover(function(){
		$(this).find("#qr-code").show();
	},function(){
		$(this).find("#qr-code").hide();
	});
	//tab
	$(".chosetab .idx_cm_title a").click(function(){
		var n=$(this).index();
		$(this).parent().find("a").removeClass("title");
		$(this).addClass("title");
		$(this).parent().parent().find(".news-content").hide();
		$(this).parent().parent().find(".news-content").eq(n).show();
	});
	//生成分享二维码
	if($(".ne-shares-qrcode").length>0){
		$(".ne-shares-qrcode").each(function(){
			var xxurl=$(this).attr("title");
			var weburl ="http://"+window.location.hostname;
			$(this).qrcode({render:"canvas",width:110,height:110,text:weburl+xxurl});
		});
	}
	//内容页二维码生成
	if($("#qr-code").length>0){
		var weburl = window.location.href;
		jQuery('#qr-code').qrcode({render:"canvas",width:110,height:110,text:weburl});	
	}
	//顶部会员菜单
	$(".user").hover(function(){
		$(this).find(".menu-list").show();
		$(this).find(".user-list").addClass("on");
	},function(){
		$(this).find(".menu-list").hide();
		$(this).find(".user-list").removeClass("on");	
	})
	//自动给标签加不同颜色
	if($(".listbq").length>0){
    $(".listbq").each(function(){
      if($(this).text()=="热评"){$(this).addClass("bqred");}
      if($(this).text()=="视频"){$(this).addClass("bqblue");}
    });
	}
	//手机端右侧菜单
	$(".wap-top-nav").click(function(){
    $(".phonenav").toggle();
	});
	//设置栏目名
	if($(".lmname").length>0){
    var nr=$(".lmname").text();
    if(nr){
      $(".zk-wap-logotile").text(nr);
    }
	}
	//ajaxlogin
	$('#login_board .inner_title').on('click','.login_nav:not(.active)',function(){
            $('#login_board .inner_title .active').removeClass('active');
            $(this).addClass('active');
            var to_nav = $(this).attr('to_nav');
            if (to_nav=='register') $('#login_board .common_board').addClass('register');
            else $('#login_board .common_board').removeClass('register');
        })

        $('#login_board .full_bg').click(function(){
            $('#login_board').fadeOut(300,function(){
                $('#login_board input').val('').removeClass('warn');
            });
        })

        $('#login_board .input_line input').on('keydown',function(e){
            if (e.keyCode==13){
                $(this).closest('.lefter').find('.input_line.sure .sure_btn').click();
            }
        })
		$("#login_board .login .sure_btn").click(function(){
			yzlogin();
		});
		$("#login_board .register .sure_btn").click(function(){
			yzreg();
		});
	//返回顶部
	gettop();
	autojz();
	//加载信息
	loadxx();
})

function gettop(){
  $.get("/top.html",{},function(data) {
					$("body").append(data);
	$("#izl_rmenu").each(function(){
		$(this).find(".btn-wx").mouseenter(function(){
			$(this).find(".pic").fadeIn("fast");
		});
		$(this).find(".btn-wx").mouseleave(function(){
			$(this).find(".pic").fadeOut("fast");
		});
		$(this).find(".btn-phone").mouseenter(function(){
			$(this).find(".phone").fadeIn("fast");
		});
		$(this).find(".btn-phone").mouseleave(function(){
			$(this).find(".phone").fadeOut("fast");
		});
		$(this).find(".btn-top").click(function(){
			$("html, body").animate({
				"scroll-top":0
			},"fast");
		});
	});
	var lastRmenuStatus=false;
	var ewmtop=0;
	if($(".ttxcx").length>0){
    ewmtop=$(".ttxcx").offset().top;
	}
	$(window).scroll(function(){
		var _top=$(window).scrollTop();
		if(_top>200){
			$("#izl_rmenu").data("expanded",true);
		}else{
			$("#izl_rmenu").data("expanded",false);
		}
		if(_top>ewmtop){
      $(".ttxcx").css({"position":"fixed","top":"0"});
		} else {
      $(".ttxcx").css({"position":"","top":""});
		}
		
		
		if($("#izl_rmenu").data("expanded")!=lastRmenuStatus){
			lastRmenuStatus=$("#izl_rmenu").data("expanded");
			if(lastRmenuStatus){
        $("#izl_rmenu .btnindex").fadeIn();
				$("#izl_rmenu .btn-top").fadeIn();
			}else{
        $("#izl_rmenu .btnindex").fadeOut();
				$("#izl_rmenu .btn-top").fadeOut();
			}
		}
	});
	});
}

function autojz(){
  var isjz=1;
	$(window).scroll(function(){
    if ($(".loadxx").length>0 && ($(document).scrollTop()>=($(document).height()-$(window).height())-100)){
			//加载数据
			if(isjz==1){
			isjz=0;
			var classid=$(".loadxx").attr("classid"),page=Number($(".loadxx").attr("page")),addxx=$(".loadxx").attr("addxx");
			$(".loadxx").show();
        $.get("/e/extend/load/index.php?classid="+classid+"&page="+page+addxx,function(data,status){
          var obj = eval( "(" + data + ")" );
          isjz=1;
          if (obj.zt=="none"){
            $(".loadxx").after('<div class="haveno">已加载完全部信息</div>');
            $(".loadxx").remove();
          } else if(obj.zt=="error"){
            alert('获取内容出错,请重试!');
          } else if(obj.zt=="success") {
            $(".loadxx").attr("page",page+1);
            $(".loadxx").hide();
            $("#listBox").append(obj.listnr);
            loadxx();
          } else{};
        })
     }
	}
	//搜索加载 
	   if ($(".loadss").length>0 && ($(document).scrollTop()>=($(document).height()-$(window).height())-100)){
			//加载数据
        var classid=$(".loadss").attr("searchid"),page=Number($(".loadss").attr("page"));
        if(isjz==1){
        isjz=0;
        $(".loadss").show();
        $.get("/e/search/result/ajax.php?searchid="+classid+"&page="+page,function(data,status){
          var obj = eval( "(" + data + ")" );
          isjz=1;
          if (obj.zt=="none"){
            //alert('没有更多内容咯!');
            $(".loadss").after('<div class="haveno">已加载完全部信息</div>');
            $(".loadss").remove();
          } else if(obj.zt=="error"){
            alert('获取内容出错,请重试!');
          } else if(obj.zt=="success") {
            $(".loadss").attr("page",page+1);
            $(".loadss").hide();
            $("#listBox").append(obj.listnr);
            loadxx();
          } else{};
        })
    }
	}
	
	})
}
	
function gaoliang(){
	var nowurl=window.location.pathname,nowcs=window.location.search;
	var turl=nowurl+nowcs;
	$(".navmenu a").each(function() {
		nurl=$(this).attr("href");
		if (((nurl==turl) || (turl.indexOf(nurl)>=0)) && (turl!=="/")){
			$(".navmenu a").removeClass("on");
			$(this).addClass("on");
		}
	})
	$(".headmenu li").each(function() {
		nurl=$(this).find("a").attr("href");
		if (((nurl==turl) || (turl.indexOf(nurl)>=0)) && (turl!=="/")){
			$(".headmenu li a").removeClass("on");
			$(this).find("a").addClass("on");
		}
	})
}

//ajax收藏
function sc(classid,id){
	$.post("/e/member/doaction.php",
		{
		  classid:classid,
		  id:id,
		  enews:"ajaxAddFava"
		},function(data,status){
			switch(data){
				case"error":layer.msg('收藏错误,请重试!');break;
				case"nologin":
//layer.msg('请先登陆!');
        window.location.href="/e/member/login/?from="+window.location.href;
        break;
				case"ReFava":layer.msg('您已经收藏过此信息!');break;
				case"MoreFava":layer.msg('您收藏数已达上限!');break;
				case"AddFavaSuccess":layer.alert('<p class="pop_info_show">已收藏<br><a href="/e/member/fava/" class="a_small a_underline">去我的收藏夹 <span class="arrow">&gt;</span></a></p>', {icon: 1,time:3000});$("#sc"+id).text(parseInt($("#sc"+id).text())+parseInt(1));$("#sc"+id).parent().addClass("current");loadxx();break;
				case"DbError":layer.msg('数据库连接错误,请联系管理员!');break;
			}
	})
}


function loadxx(){
		if($(".scnum").length>0){
			$(".scnum").each(function(){
				 $(this).load("/e/extend/view/?lx=scnum&classid="+$(this).attr("classid")+"&id="+$(this).attr("xxid"));
			});
		}
		if($(".plnum").length>0){
			$(".plnum").each(function(){
				 $(this).load("/e/extend/view/?lx=plnum&classid="+$(this).attr("classid")+"&id="+$(this).attr("xxid"));
			});
		}
}

//分享信息
function sharexx(){
  var weburl = window.location.href;
  $(".nrewm").qrcode({render:"canvas",width:200,height:200,text:weburl});	
  layer.open({
    type: 1, 
    title :'扫描二维码分享',
    area: ['400px', '400px'],
    content:$('.xxewm')
  });
}

//选择周报
function chosezb(){
	var riqi=$("#kxdate").val();
	if(!riqi){
		layer.msg('请选择日期');return false;
	}
	var strs= new Array(); 
	strs=riqi.split("-");
	window.location.href="/weekly/"+strs[0]+"/"+strs[1]+"/";	
}

function dasang(classid,id){
	if(classid && id){
		$.post("/e/ecmsshop/dasang/index.php",{enews:"tx"},function (data){
				var obj = eval( "(" + data + ")" );
				var userpic="/e/ecmsshop/dasang/images/user.jpg",username="匿名";
				var sjfen=(Math.random()*max+min).toFixed(1);
				if(obj.zt=="ok"){
					userpic=obj.userpic;
					username=obj.username;
				}
				if(isphone()){
          layer.open({
					type: 1,
					title:"我要打赏",
					shift: 2,
					icon: 1,
					shade: 0.4, //遮罩透明度
					area: ['90%','420px'], //弹出框大小
					content: '<div class="dasangtx"><a class="reward-img-box" href="javascript:;"><img node-type="headImg" class="reward-head-img" src="'+userpic+'"></a><p class="reward-user-name">'+username+'</p></div><div class="reward-in"><label class="icon-mon" for="endzy-rewardNum">积分</label><input id="endzy-rewardNum" class="reward-num" type="text" value="'+sjfen+'"><label for="endzy-rewardNum" class="reward-random" onclick="getpoint()"></label></div>',
					btn: ['确定打赏'],
					yes:function(index){
						var fen=$("#endzy-rewardNum").val();
						$.post("/e/ecmsshop/dasang/index.php",{enews:"dasang",id:id,classid:classid,fen:fen},function (data){
							var obj = eval( "(" + data + ")" );
							if(obj.zt=="ok"){
								layer.msg('打赏成功!', {icon: 1});
								layer.close(index);
							} else if(obj.zt=="error"){
								layer.msg('请把信息填写完整!');
							} else if(obj.zt=="fenerror"){
								layer.msg('积分值超出打赏范围!');
							} else if(obj.zt=="fenbz"){
								layer.msg('您的积分不足!');
							} else if(obj.zt=="nologin"){
								layer.msg('请先登陆后再进行打赏!');
							} else{
								layer.msg('数据库连接错误!');
							}
						})
					}
				});
				} else {
          layer.open({
					type: 1,
					title:"我要打赏",
					shift: 2,
					icon: 1,
					shade: 0.4, //遮罩透明度
					area: ['460px','420px'], //弹出框大小
					content: '<div class="dasangtx"><a class="reward-img-box" href="javascript:;"><img node-type="headImg" class="reward-head-img" src="'+userpic+'"></a><p class="reward-user-name">'+username+'</p></div><div class="reward-in"><label class="icon-mon" for="endzy-rewardNum">积分</label><input id="endzy-rewardNum" class="reward-num" type="text" value="'+sjfen+'"><label for="endzy-rewardNum" class="reward-random" onclick="getpoint()"></label></div>',
					btn: ['确定打赏'],
					yes:function(index){
						var fen=$("#endzy-rewardNum").val();
						$.post("/e/ecmsshop/dasang/index.php",{enews:"dasang",id:id,classid:classid,fen:fen},function (data){
							var obj = eval( "(" + data + ")" );
							if(obj.zt=="ok"){
								layer.msg('打赏成功!', {icon: 1});
								layer.close(index);
							} else if(obj.zt=="error"){
								layer.msg('请把信息填写完整!');
							} else if(obj.zt=="fenerror"){
								layer.msg('积分值超出打赏范围!');
							} else if(obj.zt=="fenbz"){
								layer.msg('您的积分不足!');
							} else if(obj.zt=="nologin"){
								layer.msg('请先登陆后再进行打赏!');
							} else{
								layer.msg('数据库连接错误!');
							}
						})
					}
				});
				}
		})
	} else {
		layer.msg('参数错误');
	}
}

function getpoint(){
	var sjfen="";
	sjfen=Math.random()*max+min;
	$("#endzy-rewardNum").val(sjfen.toFixed(1));
}

function isphone(){
  var sUserAgent = navigator.userAgent.toLowerCase();
  var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
  var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
  var bIsMidp = sUserAgent.match(/midp/i) == "midp";
  var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
  var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
  var bIsAndroid = sUserAgent.match(/android/i) == "android";
  var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
  var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
  if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {
    return true;
  } else {
    return false;
  }
}

//ajaxlogin
function ajaxreg(){
	$("#login_board").show();
	$("#login_board .login_nav[to_nav='register']").click();
}

function ajaxlogin(){
	$("#login_board").show();
	$("#login_board .login_nav[to_nav='login']").click();
}

function yzreg(){
	var username,pwd,repassword,email,key=0,groupid=1;
	username=$("#login_board .common_board .register .nickname").find("input").val();
	pwd=$("#login_board .common_board .register #regpwd").val();
	repassword=$("#login_board .register .password_check").find("input").val();
	email=$("#login_board .common_board .register .username").find("input").val();
	key=$("#key").val();
	if (username==""){
		layer.msg("用户名不能为空哦!");document.getElementById("username").focus();return false;
	}
	if (pwd=="" || repassword==""){
		layer.msg("密码不能为空哦!");document.getElementById("password").focus();return false;
	}
	if (email==""){
		layer.msg("邮箱不能为空!");document.getElementById("password").focus();return false;
	}
	$.post("/e/member/doaction.php",
		{
			username:username,
			password:pwd,
			repassword:repassword,
			email:email,
			groupid:groupid,
			key:key,
			enews:"ajaxreg"
		},
		function(data,status){
			 switch(data){
				 case"CloseRegister":layer.msg("本站未开启注册!");
				 break;
				 case"OutKeytime":layer.msg("验证码超时,请点击刷新后重新输入!");
				 break;
				 case"FailKey":layer.msg("验证码错误,请重新输入!");
				 break;
				 case"LoginToRegister":layer.msg("您已经登陆,无法再次注册!");
				 break;
				 case"FaiUserlen":layer.msg("用户名太短,请输入6位以上用户名!");
				 break;
				 case"FailPasslen":layer.msg("密码太短,请输入6位以上密码!");
				 break;
				 case"NotRepassword":layer.msg("两次输入的密码不符合!");
				 break;
				 case"EmailFail":layer.msg("您输入的邮箱有误!");
				 break;
				 case"NotSpeWord":layer.msg("用户名不能包含特殊字符!");
				 break;
				 case"ReUsername":layer.msg("此用户名已被注册，请重填！");
				 break;
				 case"ReEmailFail":layer.msg("此邮箱已被注册");
				 break; 
				 case"DbError":layer.msg("数据库错误,请联系管理员!");
				 break;
				 case"RegisterSuccessCheck":jSuccess("注册成功,请等待审核!",{HorizontalPosition : 'center',VerticalPosition:'center',onClosed : function(){window.top.location.reload();}})
				 break;
				 case"SendActUserEmailSucess":jSuccess("注册成功,请去邮箱激活您的帐号!",{HorizontalPosition : 'center',VerticalPosition:'center',onClosed : function(){window.top.location.reload();}})
				 break;
				 case"RegisterSuccess":
				 layer.msg('注册成功,页面跳转中..请稍后',{icon:1},function(){
            window.top.location.reload();
				 })
				 break;
			 }
			}
		)
}

function yzlogin(){
	var username,password,ecmsfrom,lifetime;
	username=$("#login_board .login .username").find("input").val();
	password=$("#login_board .login .password").find("input").val();
	lifetime=0;
	if ($("#login_board .login .remember").find("input").is(":checked")){
		lifetime="315360000";
	}
	if (username==""){
		layer.msg("用户名不能为空哦!");return false;
		}
	if (password==""){
		layer.msg("密码不能为空哦!");return false;
		}
	$.post("/e/member/doaction.php",
		{
			username:username,
			password:password,
			lifetime:lifetime,
			enews:"Ajaxlogin",
			tobind:"0"
		},
		function(data,status){
			 switch(data){
				 case"EmptyLogin":layer.msg("用户名和密码不能为空");
				 break;
				 case"FailPassword":layer.msg("您的用户名密码错误");
				 break;
				 case"NotCheckedUser":layer.msg("您的帐号还未通过审核!");
				 break;
				 case"NotCookie":layer.msg("登录不成功，请确认您的cookie是否已开启!");
				 break;
				 case"LoginSuccess":
				 layer.msg('欢迎回来..',{icon:1},function(){
            window.top.location.reload();
				 })
				 break;
			 }
			}
		)
}
