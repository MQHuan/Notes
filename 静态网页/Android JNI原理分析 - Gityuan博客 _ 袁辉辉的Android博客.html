<!DOCTYPE html>
<!-- saved from url=(0042)http://gityuan.com/2016/05/28/android-jni/ -->
<html lang="en" class="gr__gityuan_com"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style class="anchorjs"></style><style class="darkreader darkreader--sync" media="screen"></style><style class="darkreader darkreader--fallback" media="screen"></style><style class="darkreader darkreader--text" media="screen"></style><style class="darkreader darkreader--invert" media="screen"></style><style class="darkreader darkreader--inline" media="screen">[data-darkreader-inline-bgcolor] {
  background-color: var(--darkreader-inline-bgcolor) !important;
}
[data-darkreader-inline-bgimage] {
  background-image: var(--darkreader-inline-bgimage) !important;
}
[data-darkreader-inline-border] {
  border-color: var(--darkreader-inline-border) !important;
}
[data-darkreader-inline-border-bottom] {
  border-bottom-color: var(--darkreader-inline-border-bottom) !important;
}
[data-darkreader-inline-border-left] {
  border-left-color: var(--darkreader-inline-border-left) !important;
}
[data-darkreader-inline-border-right] {
  border-right-color: var(--darkreader-inline-border-right) !important;
}
[data-darkreader-inline-border-top] {
  border-top-color: var(--darkreader-inline-border-top) !important;
}
[data-darkreader-inline-boxshadow] {
  box-shadow: var(--darkreader-inline-boxshadow) !important;
}
[data-darkreader-inline-color] {
  color: var(--darkreader-inline-color) !important;
}
[data-darkreader-inline-fill] {
  fill: var(--darkreader-inline-fill) !important;
}
[data-darkreader-inline-stroke] {
  stroke: var(--darkreader-inline-stroke) !important;
}
[data-darkreader-inline-outline] {
  outline-color: var(--darkreader-inline-outline) !important;
}</style><style class="darkreader darkreader--user-agent" media="screen">html {
    background-color: #0b0b0c !important;
}
html, body, input, textarea, select, button {
    background-color: #0b0b0c;
}
html, body, input, textarea, select, button {
    border-color: #4c4b49;
    color: #e0dcd5;
}
a {
    color: #5e7ea2;
}
table {
    border-color: #41403e;
}
::placeholder {
    color: #ada9a2;
}
::selection {
    background-color: #29486f;
    color: #f8f5ee;
}
::-moz-selection {
    background-color: #29486f;
    color: #f8f5ee;
}
input:-webkit-autofill,
textarea:-webkit-autofill,
select:-webkit-autofill {
    background-color: #484927 !important;
    color: #e0dcd5 !important;
}
::-webkit-scrollbar {
    background-color: #0f0f11;
    color: #b9b5ae;
}
::-webkit-scrollbar-thumb {
    background-color: #1c1d20;
}
::-webkit-scrollbar-thumb:hover {
    background-color: #232528;
}
::-webkit-scrollbar-thumb:active {
    background-color: #2c3035;
}
::-webkit-scrollbar-corner {
    background-color: #0b0b0c;
}
* {
    scrollbar-color: #1c1d20 #0f0f11;
}</style>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" content="max-age=36000">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="gityuan">
    <meta name="keyword" content="Android,Gityuan,Android博客,Android源码,袁辉辉">
    <meta name="description" content="Android架构,Gityuan,Android博客,Android源码,袁辉辉">
    <meta name="baidu-site-verification" content="LToTaY8RGk">
    <link rel="shortcut icon" href="http://gityuan.com/images/favicon.ico">
    <title>Android JNI原理分析 - Gityuan博客 | 袁辉辉的Android博客</title>

    <link rel="canonical" href="http://gityuan.com/2016/05/28/android-jni/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/bootstrap.min.css"><style class="darkreader darkreader--sync" media="screen"></style>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/hux-blog.min.css"><style class="darkreader darkreader--sync" media="screen"></style>

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/syntax.css"><style class="darkreader darkreader--sync" media="screen"></style>

    <!-- Custom Fonts -->
    <!-- change font-awesome CDN to qiniu -->
    <link href="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/font-awesome.min.css" rel="stylesheet" type="text/css"><style class="darkreader darkreader--cors" media="screen">.fa{display:inline-block;font:normal normal normal 14px/1 FontAwesome;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.fa-lg{font-size:1.33333333em;line-height:.75em;vertical-align:-15%}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-fw{width:1.28571429em;text-align:center}.fa-ul{padding-left:0;margin-left:2.14285714em;list-style-type:none}.fa-ul>li{position:relative}.fa-li{position:absolute;left:-2.14285714em;width:2.14285714em;top:.14285714em;text-align:center}.fa-li.fa-lg{left:-1.85714286em}.fa-border{padding:.2em .25em .15em;border:solid .08em #eee;border-radius:.1em}.pull-right{float:right}.pull-left{float:left}.fa.pull-left{margin-right:.3em}.fa.pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}.fa-rotate-90{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=1);-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=2);-webkit-transform:rotate(180deg);-ms-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=3);-webkit-transform:rotate(270deg);-ms-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=0, mirror=1);-webkit-transform:scale(-1, 1);-ms-transform:scale(-1, 1);transform:scale(-1, 1)}.fa-flip-vertical{filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=2, mirror=1);-webkit-transform:scale(1, -1);-ms-transform:scale(1, -1);transform:scale(1, -1)}:root .fa-rotate-90,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-flip-horizontal,:root .fa-flip-vertical{filter:none}.fa-stack{position:relative;display:inline-block;width:2em;height:2em;line-height:2em;vertical-align:middle}.fa-stack-1x,.fa-stack-2x{position:absolute;left:0;width:100%;text-align:center}.fa-stack-1x{line-height:inherit}.fa-stack-2x{font-size:2em}.fa-inverse{color:#fff}.fa-glass:before{content:"\f000"}.fa-music:before{content:"\f001"}.fa-search:before{content:"\f002"}.fa-envelope-o:before{content:"\f003"}.fa-heart:before{content:"\f004"}.fa-star:before{content:"\f005"}.fa-star-o:before{content:"\f006"}.fa-user:before{content:"\f007"}.fa-film:before{content:"\f008"}.fa-th-large:before{content:"\f009"}.fa-th:before{content:"\f00a"}.fa-th-list:before{content:"\f00b"}.fa-check:before{content:"\f00c"}.fa-remove:before,.fa-close:before,.fa-times:before{content:"\f00d"}.fa-search-plus:before{content:"\f00e"}.fa-search-minus:before{content:"\f010"}.fa-power-off:before{content:"\f011"}.fa-signal:before{content:"\f012"}.fa-gear:before,.fa-cog:before{content:"\f013"}.fa-trash-o:before{content:"\f014"}.fa-home:before{content:"\f015"}.fa-file-o:before{content:"\f016"}.fa-clock-o:before{content:"\f017"}.fa-road:before{content:"\f018"}.fa-download:before{content:"\f019"}.fa-arrow-circle-o-down:before{content:"\f01a"}.fa-arrow-circle-o-up:before{content:"\f01b"}.fa-inbox:before{content:"\f01c"}.fa-play-circle-o:before{content:"\f01d"}.fa-rotate-right:before,.fa-repeat:before{content:"\f01e"}.fa-refresh:before{content:"\f021"}.fa-list-alt:before{content:"\f022"}.fa-lock:before{content:"\f023"}.fa-flag:before{content:"\f024"}.fa-headphones:before{content:"\f025"}.fa-volume-off:before{content:"\f026"}.fa-volume-down:before{content:"\f027"}.fa-volume-up:before{content:"\f028"}.fa-qrcode:before{content:"\f029"}.fa-barcode:before{content:"\f02a"}.fa-tag:before{content:"\f02b"}.fa-tags:before{content:"\f02c"}.fa-book:before{content:"\f02d"}.fa-bookmark:before{content:"\f02e"}.fa-print:before{content:"\f02f"}.fa-camera:before{content:"\f030"}.fa-font:before{content:"\f031"}.fa-bold:before{content:"\f032"}.fa-italic:before{content:"\f033"}.fa-text-height:before{content:"\f034"}.fa-text-width:before{content:"\f035"}.fa-align-left:before{content:"\f036"}.fa-align-center:before{content:"\f037"}.fa-align-right:before{content:"\f038"}.fa-align-justify:before{content:"\f039"}.fa-list:before{content:"\f03a"}.fa-dedent:before,.fa-outdent:before{content:"\f03b"}.fa-indent:before{content:"\f03c"}.fa-video-camera:before{content:"\f03d"}.fa-photo:before,.fa-image:before,.fa-picture-o:before{content:"\f03e"}.fa-pencil:before{content:"\f040"}.fa-map-marker:before{content:"\f041"}.fa-adjust:before{content:"\f042"}.fa-tint:before{content:"\f043"}.fa-edit:before,.fa-pencil-square-o:before{content:"\f044"}.fa-share-square-o:before{content:"\f045"}.fa-check-square-o:before{content:"\f046"}.fa-arrows:before{content:"\f047"}.fa-step-backward:before{content:"\f048"}.fa-fast-backward:before{content:"\f049"}.fa-backward:before{content:"\f04a"}.fa-play:before{content:"\f04b"}.fa-pause:before{content:"\f04c"}.fa-stop:before{content:"\f04d"}.fa-forward:before{content:"\f04e"}.fa-fast-forward:before{content:"\f050"}.fa-step-forward:before{content:"\f051"}.fa-eject:before{content:"\f052"}.fa-chevron-left:before{content:"\f053"}.fa-chevron-right:before{content:"\f054"}.fa-plus-circle:before{content:"\f055"}.fa-minus-circle:before{content:"\f056"}.fa-times-circle:before{content:"\f057"}.fa-check-circle:before{content:"\f058"}.fa-question-circle:before{content:"\f059"}.fa-info-circle:before{content:"\f05a"}.fa-crosshairs:before{content:"\f05b"}.fa-times-circle-o:before{content:"\f05c"}.fa-check-circle-o:before{content:"\f05d"}.fa-ban:before{content:"\f05e"}.fa-arrow-left:before{content:"\f060"}.fa-arrow-right:before{content:"\f061"}.fa-arrow-up:before{content:"\f062"}.fa-arrow-down:before{content:"\f063"}.fa-mail-forward:before,.fa-share:before{content:"\f064"}.fa-expand:before{content:"\f065"}.fa-compress:before{content:"\f066"}.fa-plus:before{content:"\f067"}.fa-minus:before{content:"\f068"}.fa-asterisk:before{content:"\f069"}.fa-exclamation-circle:before{content:"\f06a"}.fa-gift:before{content:"\f06b"}.fa-leaf:before{content:"\f06c"}.fa-fire:before{content:"\f06d"}.fa-eye:before{content:"\f06e"}.fa-eye-slash:before{content:"\f070"}.fa-warning:before,.fa-exclamation-triangle:before{content:"\f071"}.fa-plane:before{content:"\f072"}.fa-calendar:before{content:"\f073"}.fa-random:before{content:"\f074"}.fa-comment:before{content:"\f075"}.fa-magnet:before{content:"\f076"}.fa-chevron-up:before{content:"\f077"}.fa-chevron-down:before{content:"\f078"}.fa-retweet:before{content:"\f079"}.fa-shopping-cart:before{content:"\f07a"}.fa-folder:before{content:"\f07b"}.fa-folder-open:before{content:"\f07c"}.fa-arrows-v:before{content:"\f07d"}.fa-arrows-h:before{content:"\f07e"}.fa-bar-chart-o:before,.fa-bar-chart:before{content:"\f080"}.fa-twitter-square:before{content:"\f081"}.fa-facebook-square:before{content:"\f082"}.fa-camera-retro:before{content:"\f083"}.fa-key:before{content:"\f084"}.fa-gears:before,.fa-cogs:before{content:"\f085"}.fa-comments:before{content:"\f086"}.fa-thumbs-o-up:before{content:"\f087"}.fa-thumbs-o-down:before{content:"\f088"}.fa-star-half:before{content:"\f089"}.fa-heart-o:before{content:"\f08a"}.fa-sign-out:before{content:"\f08b"}.fa-linkedin-square:before{content:"\f08c"}.fa-thumb-tack:before{content:"\f08d"}.fa-external-link:before{content:"\f08e"}.fa-sign-in:before{content:"\f090"}.fa-trophy:before{content:"\f091"}.fa-github-square:before{content:"\f092"}.fa-upload:before{content:"\f093"}.fa-lemon-o:before{content:"\f094"}.fa-phone:before{content:"\f095"}.fa-square-o:before{content:"\f096"}.fa-bookmark-o:before{content:"\f097"}.fa-phone-square:before{content:"\f098"}.fa-twitter:before{content:"\f099"}.fa-facebook:before{content:"\f09a"}.fa-github:before{content:"\f09b"}.fa-unlock:before{content:"\f09c"}.fa-credit-card:before{content:"\f09d"}.fa-rss:before{content:"\f09e"}.fa-hdd-o:before{content:"\f0a0"}.fa-bullhorn:before{content:"\f0a1"}.fa-bell:before{content:"\f0f3"}.fa-certificate:before{content:"\f0a3"}.fa-hand-o-right:before{content:"\f0a4"}.fa-hand-o-left:before{content:"\f0a5"}.fa-hand-o-up:before{content:"\f0a6"}.fa-hand-o-down:before{content:"\f0a7"}.fa-arrow-circle-left:before{content:"\f0a8"}.fa-arrow-circle-right:before{content:"\f0a9"}.fa-arrow-circle-up:before{content:"\f0aa"}.fa-arrow-circle-down:before{content:"\f0ab"}.fa-globe:before{content:"\f0ac"}.fa-wrench:before{content:"\f0ad"}.fa-tasks:before{content:"\f0ae"}.fa-filter:before{content:"\f0b0"}.fa-briefcase:before{content:"\f0b1"}.fa-arrows-alt:before{content:"\f0b2"}.fa-group:before,.fa-users:before{content:"\f0c0"}.fa-chain:before,.fa-link:before{content:"\f0c1"}.fa-cloud:before{content:"\f0c2"}.fa-flask:before{content:"\f0c3"}.fa-cut:before,.fa-scissors:before{content:"\f0c4"}.fa-copy:before,.fa-files-o:before{content:"\f0c5"}.fa-paperclip:before{content:"\f0c6"}.fa-save:before,.fa-floppy-o:before{content:"\f0c7"}.fa-square:before{content:"\f0c8"}.fa-navicon:before,.fa-reorder:before,.fa-bars:before{content:"\f0c9"}.fa-list-ul:before{content:"\f0ca"}.fa-list-ol:before{content:"\f0cb"}.fa-strikethrough:before{content:"\f0cc"}.fa-underline:before{content:"\f0cd"}.fa-table:before{content:"\f0ce"}.fa-magic:before{content:"\f0d0"}.fa-truck:before{content:"\f0d1"}.fa-pinterest:before{content:"\f0d2"}.fa-pinterest-square:before{content:"\f0d3"}.fa-google-plus-square:before{content:"\f0d4"}.fa-google-plus:before{content:"\f0d5"}.fa-money:before{content:"\f0d6"}.fa-caret-down:before{content:"\f0d7"}.fa-caret-up:before{content:"\f0d8"}.fa-caret-left:before{content:"\f0d9"}.fa-caret-right:before{content:"\f0da"}.fa-columns:before{content:"\f0db"}.fa-unsorted:before,.fa-sort:before{content:"\f0dc"}.fa-sort-down:before,.fa-sort-desc:before{content:"\f0dd"}.fa-sort-up:before,.fa-sort-asc:before{content:"\f0de"}.fa-envelope:before{content:"\f0e0"}.fa-linkedin:before{content:"\f0e1"}.fa-rotate-left:before,.fa-undo:before{content:"\f0e2"}.fa-legal:before,.fa-gavel:before{content:"\f0e3"}.fa-dashboard:before,.fa-tachometer:before{content:"\f0e4"}.fa-comment-o:before{content:"\f0e5"}.fa-comments-o:before{content:"\f0e6"}.fa-flash:before,.fa-bolt:before{content:"\f0e7"}.fa-sitemap:before{content:"\f0e8"}.fa-umbrella:before{content:"\f0e9"}.fa-paste:before,.fa-clipboard:before{content:"\f0ea"}.fa-lightbulb-o:before{content:"\f0eb"}.fa-exchange:before{content:"\f0ec"}.fa-cloud-download:before{content:"\f0ed"}.fa-cloud-upload:before{content:"\f0ee"}.fa-user-md:before{content:"\f0f0"}.fa-stethoscope:before{content:"\f0f1"}.fa-suitcase:before{content:"\f0f2"}.fa-bell-o:before{content:"\f0a2"}.fa-coffee:before{content:"\f0f4"}.fa-cutlery:before{content:"\f0f5"}.fa-file-text-o:before{content:"\f0f6"}.fa-building-o:before{content:"\f0f7"}.fa-hospital-o:before{content:"\f0f8"}.fa-ambulance:before{content:"\f0f9"}.fa-medkit:before{content:"\f0fa"}.fa-fighter-jet:before{content:"\f0fb"}.fa-beer:before{content:"\f0fc"}.fa-h-square:before{content:"\f0fd"}.fa-plus-square:before{content:"\f0fe"}.fa-angle-double-left:before{content:"\f100"}.fa-angle-double-right:before{content:"\f101"}.fa-angle-double-up:before{content:"\f102"}.fa-angle-double-down:before{content:"\f103"}.fa-angle-left:before{content:"\f104"}.fa-angle-right:before{content:"\f105"}.fa-angle-up:before{content:"\f106"}.fa-angle-down:before{content:"\f107"}.fa-desktop:before{content:"\f108"}.fa-laptop:before{content:"\f109"}.fa-tablet:before{content:"\f10a"}.fa-mobile-phone:before,.fa-mobile:before{content:"\f10b"}.fa-circle-o:before{content:"\f10c"}.fa-quote-left:before{content:"\f10d"}.fa-quote-right:before{content:"\f10e"}.fa-spinner:before{content:"\f110"}.fa-circle:before{content:"\f111"}.fa-mail-reply:before,.fa-reply:before{content:"\f112"}.fa-github-alt:before{content:"\f113"}.fa-folder-o:before{content:"\f114"}.fa-folder-open-o:before{content:"\f115"}.fa-smile-o:before{content:"\f118"}.fa-frown-o:before{content:"\f119"}.fa-meh-o:before{content:"\f11a"}.fa-gamepad:before{content:"\f11b"}.fa-keyboard-o:before{content:"\f11c"}.fa-flag-o:before{content:"\f11d"}.fa-flag-checkered:before{content:"\f11e"}.fa-terminal:before{content:"\f120"}.fa-code:before{content:"\f121"}.fa-mail-reply-all:before,.fa-reply-all:before{content:"\f122"}.fa-star-half-empty:before,.fa-star-half-full:before,.fa-star-half-o:before{content:"\f123"}.fa-location-arrow:before{content:"\f124"}.fa-crop:before{content:"\f125"}.fa-code-fork:before{content:"\f126"}.fa-unlink:before,.fa-chain-broken:before{content:"\f127"}.fa-question:before{content:"\f128"}.fa-info:before{content:"\f129"}.fa-exclamation:before{content:"\f12a"}.fa-superscript:before{content:"\f12b"}.fa-subscript:before{content:"\f12c"}.fa-eraser:before{content:"\f12d"}.fa-puzzle-piece:before{content:"\f12e"}.fa-microphone:before{content:"\f130"}.fa-microphone-slash:before{content:"\f131"}.fa-shield:before{content:"\f132"}.fa-calendar-o:before{content:"\f133"}.fa-fire-extinguisher:before{content:"\f134"}.fa-rocket:before{content:"\f135"}.fa-maxcdn:before{content:"\f136"}.fa-chevron-circle-left:before{content:"\f137"}.fa-chevron-circle-right:before{content:"\f138"}.fa-chevron-circle-up:before{content:"\f139"}.fa-chevron-circle-down:before{content:"\f13a"}.fa-html5:before{content:"\f13b"}.fa-css3:before{content:"\f13c"}.fa-anchor:before{content:"\f13d"}.fa-unlock-alt:before{content:"\f13e"}.fa-bullseye:before{content:"\f140"}.fa-ellipsis-h:before{content:"\f141"}.fa-ellipsis-v:before{content:"\f142"}.fa-rss-square:before{content:"\f143"}.fa-play-circle:before{content:"\f144"}.fa-ticket:before{content:"\f145"}.fa-minus-square:before{content:"\f146"}.fa-minus-square-o:before{content:"\f147"}.fa-level-up:before{content:"\f148"}.fa-level-down:before{content:"\f149"}.fa-check-square:before{content:"\f14a"}.fa-pencil-square:before{content:"\f14b"}.fa-external-link-square:before{content:"\f14c"}.fa-share-square:before{content:"\f14d"}.fa-compass:before{content:"\f14e"}.fa-toggle-down:before,.fa-caret-square-o-down:before{content:"\f150"}.fa-toggle-up:before,.fa-caret-square-o-up:before{content:"\f151"}.fa-toggle-right:before,.fa-caret-square-o-right:before{content:"\f152"}.fa-euro:before,.fa-eur:before{content:"\f153"}.fa-gbp:before{content:"\f154"}.fa-dollar:before,.fa-usd:before{content:"\f155"}.fa-rupee:before,.fa-inr:before{content:"\f156"}.fa-cny:before,.fa-rmb:before,.fa-yen:before,.fa-jpy:before{content:"\f157"}.fa-ruble:before,.fa-rouble:before,.fa-rub:before{content:"\f158"}.fa-won:before,.fa-krw:before{content:"\f159"}.fa-bitcoin:before,.fa-btc:before{content:"\f15a"}.fa-file:before{content:"\f15b"}.fa-file-text:before{content:"\f15c"}.fa-sort-alpha-asc:before{content:"\f15d"}.fa-sort-alpha-desc:before{content:"\f15e"}.fa-sort-amount-asc:before{content:"\f160"}.fa-sort-amount-desc:before{content:"\f161"}.fa-sort-numeric-asc:before{content:"\f162"}.fa-sort-numeric-desc:before{content:"\f163"}.fa-thumbs-up:before{content:"\f164"}.fa-thumbs-down:before{content:"\f165"}.fa-youtube-square:before{content:"\f166"}.fa-youtube:before{content:"\f167"}.fa-xing:before{content:"\f168"}.fa-xing-square:before{content:"\f169"}.fa-youtube-play:before{content:"\f16a"}.fa-dropbox:before{content:"\f16b"}.fa-stack-overflow:before{content:"\f16c"}.fa-instagram:before{content:"\f16d"}.fa-flickr:before{content:"\f16e"}.fa-adn:before{content:"\f170"}.fa-bitbucket:before{content:"\f171"}.fa-bitbucket-square:before{content:"\f172"}.fa-tumblr:before{content:"\f173"}.fa-tumblr-square:before{content:"\f174"}.fa-long-arrow-down:before{content:"\f175"}.fa-long-arrow-up:before{content:"\f176"}.fa-long-arrow-left:before{content:"\f177"}.fa-long-arrow-right:before{content:"\f178"}.fa-apple:before{content:"\f179"}.fa-windows:before{content:"\f17a"}.fa-android:before{content:"\f17b"}.fa-linux:before{content:"\f17c"}.fa-dribbble:before{content:"\f17d"}.fa-skype:before{content:"\f17e"}.fa-foursquare:before{content:"\f180"}.fa-trello:before{content:"\f181"}.fa-female:before{content:"\f182"}.fa-male:before{content:"\f183"}.fa-gittip:before{content:"\f184"}.fa-sun-o:before{content:"\f185"}.fa-moon-o:before{content:"\f186"}.fa-archive:before{content:"\f187"}.fa-bug:before{content:"\f188"}.fa-vk:before{content:"\f189"}.fa-weibo:before{content:"\f18a"}.fa-renren:before{content:"\f18b"}.fa-pagelines:before{content:"\f18c"}.fa-stack-exchange:before{content:"\f18d"}.fa-arrow-circle-o-right:before{content:"\f18e"}.fa-arrow-circle-o-left:before{content:"\f190"}.fa-toggle-left:before,.fa-caret-square-o-left:before{content:"\f191"}.fa-dot-circle-o:before{content:"\f192"}.fa-wheelchair:before{content:"\f193"}.fa-vimeo-square:before{content:"\f194"}.fa-turkish-lira:before,.fa-try:before{content:"\f195"}.fa-plus-square-o:before{content:"\f196"}.fa-space-shuttle:before{content:"\f197"}.fa-slack:before{content:"\f198"}.fa-envelope-square:before{content:"\f199"}.fa-wordpress:before{content:"\f19a"}.fa-openid:before{content:"\f19b"}.fa-institution:before,.fa-bank:before,.fa-university:before{content:"\f19c"}.fa-mortar-board:before,.fa-graduation-cap:before{content:"\f19d"}.fa-yahoo:before{content:"\f19e"}.fa-google:before{content:"\f1a0"}.fa-reddit:before{content:"\f1a1"}.fa-reddit-square:before{content:"\f1a2"}.fa-stumbleupon-circle:before{content:"\f1a3"}.fa-stumbleupon:before{content:"\f1a4"}.fa-delicious:before{content:"\f1a5"}.fa-digg:before{content:"\f1a6"}.fa-pied-piper:before{content:"\f1a7"}.fa-pied-piper-alt:before{content:"\f1a8"}.fa-drupal:before{content:"\f1a9"}.fa-joomla:before{content:"\f1aa"}.fa-language:before{content:"\f1ab"}.fa-fax:before{content:"\f1ac"}.fa-building:before{content:"\f1ad"}.fa-child:before{content:"\f1ae"}.fa-paw:before{content:"\f1b0"}.fa-spoon:before{content:"\f1b1"}.fa-cube:before{content:"\f1b2"}.fa-cubes:before{content:"\f1b3"}.fa-behance:before{content:"\f1b4"}.fa-behance-square:before{content:"\f1b5"}.fa-steam:before{content:"\f1b6"}.fa-steam-square:before{content:"\f1b7"}.fa-recycle:before{content:"\f1b8"}.fa-automobile:before,.fa-car:before{content:"\f1b9"}.fa-cab:before,.fa-taxi:before{content:"\f1ba"}.fa-tree:before{content:"\f1bb"}.fa-spotify:before{content:"\f1bc"}.fa-deviantart:before{content:"\f1bd"}.fa-soundcloud:before{content:"\f1be"}.fa-database:before{content:"\f1c0"}.fa-file-pdf-o:before{content:"\f1c1"}.fa-file-word-o:before{content:"\f1c2"}.fa-file-excel-o:before{content:"\f1c3"}.fa-file-powerpoint-o:before{content:"\f1c4"}.fa-file-photo-o:before,.fa-file-picture-o:before,.fa-file-image-o:before{content:"\f1c5"}.fa-file-zip-o:before,.fa-file-archive-o:before{content:"\f1c6"}.fa-file-sound-o:before,.fa-file-audio-o:before{content:"\f1c7"}.fa-file-movie-o:before,.fa-file-video-o:before{content:"\f1c8"}.fa-file-code-o:before{content:"\f1c9"}.fa-vine:before{content:"\f1ca"}.fa-codepen:before{content:"\f1cb"}.fa-jsfiddle:before{content:"\f1cc"}.fa-life-bouy:before,.fa-life-buoy:before,.fa-life-saver:before,.fa-support:before,.fa-life-ring:before{content:"\f1cd"}.fa-circle-o-notch:before{content:"\f1ce"}.fa-ra:before,.fa-rebel:before{content:"\f1d0"}.fa-ge:before,.fa-empire:before{content:"\f1d1"}.fa-git-square:before{content:"\f1d2"}.fa-git:before{content:"\f1d3"}.fa-hacker-news:before{content:"\f1d4"}.fa-tencent-weibo:before{content:"\f1d5"}.fa-qq:before{content:"\f1d6"}.fa-wechat:before,.fa-weixin:before{content:"\f1d7"}.fa-send:before,.fa-paper-plane:before{content:"\f1d8"}.fa-send-o:before,.fa-paper-plane-o:before{content:"\f1d9"}.fa-history:before{content:"\f1da"}.fa-circle-thin:before{content:"\f1db"}.fa-header:before{content:"\f1dc"}.fa-paragraph:before{content:"\f1dd"}.fa-sliders:before{content:"\f1de"}.fa-share-alt:before{content:"\f1e0"}.fa-share-alt-square:before{content:"\f1e1"}.fa-bomb:before{content:"\f1e2"}.fa-soccer-ball-o:before,.fa-futbol-o:before{content:"\f1e3"}.fa-tty:before{content:"\f1e4"}.fa-binoculars:before{content:"\f1e5"}.fa-plug:before{content:"\f1e6"}.fa-slideshare:before{content:"\f1e7"}.fa-twitch:before{content:"\f1e8"}.fa-yelp:before{content:"\f1e9"}.fa-newspaper-o:before{content:"\f1ea"}.fa-wifi:before{content:"\f1eb"}.fa-calculator:before{content:"\f1ec"}.fa-paypal:before{content:"\f1ed"}.fa-google-wallet:before{content:"\f1ee"}.fa-cc-visa:before{content:"\f1f0"}.fa-cc-mastercard:before{content:"\f1f1"}.fa-cc-discover:before{content:"\f1f2"}.fa-cc-amex:before{content:"\f1f3"}.fa-cc-paypal:before{content:"\f1f4"}.fa-cc-stripe:before{content:"\f1f5"}.fa-bell-slash:before{content:"\f1f6"}.fa-bell-slash-o:before{content:"\f1f7"}.fa-trash:before{content:"\f1f8"}.fa-copyright:before{content:"\f1f9"}.fa-at:before{content:"\f1fa"}.fa-eyedropper:before{content:"\f1fb"}.fa-paint-brush:before{content:"\f1fc"}.fa-birthday-cake:before{content:"\f1fd"}.fa-area-chart:before{content:"\f1fe"}.fa-pie-chart:before{content:"\f200"}.fa-line-chart:before{content:"\f201"}.fa-lastfm:before{content:"\f202"}.fa-lastfm-square:before{content:"\f203"}.fa-toggle-off:before{content:"\f204"}.fa-toggle-on:before{content:"\f205"}.fa-bicycle:before{content:"\f206"}.fa-bus:before{content:"\f207"}.fa-ioxhost:before{content:"\f208"}.fa-angellist:before{content:"\f209"}.fa-cc:before{content:"\f20a"}.fa-shekel:before,.fa-sheqel:before,.fa-ils:before{content:"\f20b"}.fa-meanpath:before{content:"\f20c"}</style><style class="darkreader darkreader--sync" media="screen"></style>
    
    <!-- add highlight -->
    <link rel="stylesheet" href="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/androidstudio.css"><style class="darkreader darkreader--sync" media="screen"></style>
		<script src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/jquery.nav.js.download"></script><script src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/fastclick.min.js.download"></script><script src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/hm.js.download"></script><script src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/anchor.min.js.download"></script><script type="text/javascript" src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/highlight.pack.js.download"></script><style class="darkreader darkreader--override" media="screen">.jfk-bubble {
    background-color: #000000 !important;
}
.vimvixen-hint {
    background-color: #574720 !important;
    border-color: #b3a266 !important;
    color: #e4ddcc !important;
}</style>
		<script>hljs.initHighlightingOnLoad();</script>
		
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="" data-gr-c-s-loaded="true">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top is-fixed">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://gityuan.com/">Gityuan</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar" class=" ">
            <div class="navbar-collapse" style="height: 0px;">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://gityuan.com/">首页</a></li>
                    <li><a href="http://gityuan.com/archive">目录</a></li>
                    <!--<li><a href="/tags">标签</a></li>-->
                    <li><a href="http://gityuan.com/talk">留言区</a></li>
                    <li><a href="http://gityuan.com/about">关于</a></li>
                    <li><a href="http://gityuan.com/friends">友链</a></li>
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- _posts目录文章布局-->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/');
    }

    
</style><style class="darkreader darkreader--sync" media="screen"></style>
<header class="intro-header">
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a target="_blank" class="tag" href="http://gityuan.com/tags/#android" title="android">android</a>
                        
                    </div>
                    <h1 id="android-jni">Android JNI原理分析</h1>
                    
                    
                    <h2 class="subheading" id=""></h2>
                    
                    <span class="meta">Posted by Gityuan on May 28, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

								<blockquote>
  <p>引言：分析Android源码6.0的过程，一定离不开Java与C/C++代码直接的来回跳转，那么就很有必要掌握JNI，这是链接Java层和Native层的桥梁，本文涉及相关源码：</p>
</blockquote>

<pre><code class="language-Java hljs">frameworks/base/core/jni/AndroidRuntime.cpp

libcore/luni/src/main/java/java/lang/System.java
libcore/luni/src/main/java/java/lang/Runtime.java
libnativehelper/JNIHelp.cpp
libnativehelper/include/nativehelper/jni.h

frameworks/base/core/java/android/os/MessageQueue.java
frameworks/base/core/jni/android_os_MessageQueue.cpp

frameworks/base/core/java/android/os/Binder.java
frameworks/base/core/jni/android_util_Binder.cpp

frameworks/base/media/java/android/media/MediaPlayer.java
frameworks/base/media/jni/android_media_MediaPlayer.cpp
</code></pre>

<h2 id="一jni概述">一、JNI概述<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#%E4%B8%80jni%E6%A6%82%E8%BF%B0" aria-label="Anchor link for: 一jni概述" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h2>

<p>JNI（Java Native Interface，Java本地接口），用于打通Java层与Native(C/C++)层。这不是Android系统所独有的，而是Java所有。众所周知，Java语言是跨平台的语言，而这跨平台的背后都是依靠Java虚拟机，虚拟机采用C/C++编写，适配各个系统，通过JNI为上层Java提供各种服务，保证跨平台性。</p>

<p>相信不少经常使用Java的程序员，享受着其跨平台性，可能全然不知JNI的存在。在Android平台，让JNI大放异彩，为更多的程序员所熟知，往往为了提供效率或者其他功能需求，就需要NDK开发。上一篇文章<a href="http://gityuan.com/2016/05/21/syscall/">Linux系统调用(syscall)原理</a>，介绍了打通android上层与底层kernel的枢纽syscall，那么本文的目的则是介绍打通android上层中Java层与Native的纽带JNI。</p>

<h2 id="二jni查找方式">二、JNI查找方式<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#%E4%BA%8Cjni%E6%9F%A5%E6%89%BE%E6%96%B9%E5%BC%8F" aria-label="Anchor link for: 二jni查找方式" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h2>

<p>Android系统在启动启动过程中，先启动Kernel创建init进程，紧接着由init进程fork第一个横穿Java和C/C++的进程，即Zygote进程。Zygote启动过程中会<code class="highlighter-rouge">AndroidRuntime.cpp</code>中的<code class="highlighter-rouge">startVm</code>创建虚拟机，VM创建完成后，紧接着调用<code class="highlighter-rouge">startReg</code>完成虚拟机中的JNI方法注册。</p>

<h3 id="21-startreg">2.1 startReg<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#21-startreg" aria-label="Anchor link for: 21 startreg" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>

<p>[–&gt;AndroidRuntime.cpp]</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs php">int AndroidRuntime::startReg(JNIEnv* env)
{
    <span class="hljs-comment">//设置线程创建方法为javaCreateThreadEtc</span>
    androidSetCreateThreadFunc((android_create_thread_fn) javaCreateThreadEtc);

    env-&gt;PushLocalFrame(<span class="hljs-number">200</span>);
    <span class="hljs-comment">//进程JNI方法的注册</span>
    <span class="hljs-keyword">if</span> (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; <span class="hljs-number">0</span>) {
        env-&gt;PopLocalFrame(<span class="hljs-keyword">NULL</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    env-&gt;PopLocalFrame(<span class="hljs-keyword">NULL</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre></div></div>

<p>register_jni_procs(gRegJNI, NELEM(gRegJNI), env)这行代码的作用就是就是循环调用<code class="highlighter-rouge">gRegJNI</code>数组成员所对应的方法。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">register_jni_procs</span><span class="hljs-params">(<span class="hljs-keyword">const</span> RegJNIRec <span class="hljs-built_in">array</span>[], size_t count, JNIEnv* env)</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span>[i].mProc(env) &lt; <span class="hljs-number">0</span>) {
            return <span class="hljs-number">-1</span>;
        }
    }
    return <span class="hljs-number">0</span>;
}
</code></pre></div></div>

<p><code class="highlighter-rouge">gRegJNI</code>数组，有100多个成员变量，定义在<code class="highlighter-rouge">AndroidRuntime.cpp</code>：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs objectivec"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> RegJNIRec gRegJNI[] = {
    REG_JNI(register_android_os_MessageQueue),
    REG_JNI(register_android_os_Binder),
    ...
};
</code></pre></div></div>

<p>该数组的每个成员都代表一个类文件的jni映射，其中REG_JNI是一个宏定义，在<a href="http://gityuan.com/2016/02/13/android-zygote">Zygote</a>中介绍过，该宏的作用就是调用相应的方法。</p>

<h3 id="22-如何查找native方法">2.2 如何查找native方法<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#22-%E5%A6%82%E4%BD%95%E6%9F%A5%E6%89%BEnative%E6%96%B9%E6%B3%95" aria-label="Anchor link for: 22 如何查找native方法" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>

<p>当大家在看framework层代码时，经常会看到native方法，这是往往需要查看所对应的C++方法在哪个文件，对应哪个方法？下面从一个实例出发带大家如何查看java层方法所对应的native方法位置。</p>

<h4 id="221-实例一">2.2.1 实例(一)<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#221-%E5%AE%9E%E4%BE%8B%E4%B8%80" aria-label="Anchor link for: 221 实例一" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h4>

<p>当分析Android消息机制源码，遇到<code class="highlighter-rouge">MessageQueue.java</code>中有多个native方法，比如：</p>

<pre><code class="language-Java hljs"><span class="hljs-keyword">package</span> android.os;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageQueue</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">nativePollOnce</span><span class="hljs-params">(<span class="hljs-keyword">long</span> ptr, <span class="hljs-keyword">int</span> timeoutMillis)</span></span>;
}
</code></pre>

<p><strong>步骤1：</strong>
<code class="highlighter-rouge">MessageQueue.java</code>的全限定名为android.os.MessageQueue.java，完整的方法名为android.os.MessageQueue.nativePollOnce()，与之相对应的native层方法名是将点号替换为下划线，即android_os_MessageQueue_nativePollOnce()。</p>

<p><strong>步骤2：</strong>
有了native方法，那么接下来需要知道该native方法所在那个文件。前面已经介绍过Android系统启动时就已经注册了大量的JNI方法，见AndroidRuntime.cpp的<code class="highlighter-rouge">gRegJNI</code>数组。这些注册方法命令方式：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs css"><span class="hljs-selector-tag">register_</span><span class="hljs-selector-attr">[包名]</span>_<span class="hljs-selector-attr">[类名]</span>
</code></pre></div></div>

<p>那么MessageQueue.java所定义的jni注册方法名应该是<code class="highlighter-rouge">register_android_os_MessageQueue</code>，的确存在于gRegJNI数组，说明这次JNI注册过程是在开机过程完成。 该方法在<code class="highlighter-rouge">AndroidRuntime.cpp</code>申明为extern方法：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">int</span> <span class="hljs-title">register_android_os_MessageQueue</span><span class="hljs-params">(JNIEnv* env)</span></span>;
</code></pre></div></div>

<p>这些extern方法绝大多数位于<code class="highlighter-rouge">/framework/base/core/jni/</code>目录，大多数情况下native文件命名方式：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs css"><span class="hljs-selector-attr">[包名]</span>_<span class="hljs-selector-attr">[类名]</span><span class="hljs-selector-class">.cpp</span>
<span class="hljs-selector-attr">[包名]</span>_<span class="hljs-selector-attr">[类名]</span><span class="hljs-selector-class">.h</span>
</code></pre></div></div>

<p><strong>Tips：</strong>  /android/os路径下的MessageQueue.java ==&gt; android_os_MessageQueue.cpp</p>

<p>打开<code class="highlighter-rouge">android_os_MessageQueue.cpp</code>文件，搜索android_os_MessageQueue_nativePollOnce方法，这便找到了目标方法：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">android_os_MessageQueue_nativePollOnce</span><span class="hljs-params">(JNIEnv* env, jobject obj,
        jlong ptr, jint timeoutMillis)</span> </span>{
    NativeMessageQueue* nativeMessageQueue = <span class="hljs-keyword">reinterpret_cast</span>&lt;NativeMessageQueue*&gt;(ptr);
    nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis);
}
</code></pre></div></div>

<p>到这里完成了一次从Java层方法搜索到所对应的C++方法的过程。</p>

<h4 id="222-实例二">2.2.2 实例(二)<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#222-%E5%AE%9E%E4%BE%8B%E4%BA%8C" aria-label="Anchor link for: 222 实例二" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h4>

<p>对于native文件命名方式，有时并非<code class="highlighter-rouge">[包名]_[类名].cpp</code>，比如/android/os路径下的Binder.java
所对应的native文件：android_util_Binder.cpp</p>

<pre><code class="language-Java hljs"><span class="hljs-keyword">package</span> android.os;
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Binder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IBinder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getCallingPid</span><span class="hljs-params">()</span></span>;
}
</code></pre>

<p>根据实例(一)方式，找到getCallingPid ==&gt; android_os_Binder_getCallingPid()，并且在AndroidRuntime.cpp中的gRegJNI数组中找到<code class="highlighter-rouge">register_android_os_Binder</code>。</p>

<p>按实例(一)方式则native文名应该为android_os_Binder.cpp，可是在<code class="highlighter-rouge">/framework/base/core/jni/</code>目录下找不到该文件，这是例外的情况。其实真正的文件名为<code class="highlighter-rouge">android_util_Binder.cpp</code>，这就是例外，这一点有些费劲，不明白为何google要如此打破规律的命名。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs php"><span class="hljs-keyword">static</span> jint android_os_Binder_getCallingPid(JNIEnv* env, jobject clazz)
{
    <span class="hljs-keyword">return</span> IPCThreadState::self()-&gt;getCallingPid();
}
</code></pre></div></div>

<p>有人可能好奇，既然如何遇到打破常规的文件命令，怎么办？这个并不难，首先，可以尝试在<code class="highlighter-rouge">/framework/base/core/jni/</code>中搜索，对于binder.java，可以直接搜索binder关键字，其他也类似。如果这里也找不到，可以通过grep全局搜索<code class="highlighter-rouge">android_os_Binder_getCallingPid</code>这个方法在哪个文件。</p>

<p><strong>jni存在的常见目录：</strong></p>

<ul>
  <li><code class="highlighter-rouge">/framework/base/core/jni/</code></li>
  <li><code class="highlighter-rouge">/framework/base/services/core/jni/</code></li>
  <li><code class="highlighter-rouge">/framework/base/media/jni/</code></li>
</ul>

<h4 id="223-实例三">2.2.3 实例(三)<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#223-%E5%AE%9E%E4%BE%8B%E4%B8%89" aria-label="Anchor link for: 223 实例三" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h4>

<p>前面两种都是在Android系统启动之初，便已经注册过JNI所对应的方法。 那么如果程序自己定义的jni方法，该如何查看jni方法所在位置呢？下面以MediaPlayer.java为例，其包名为android.media：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaPlayer</span></span>{
    <span class="hljs-keyword">static</span> {
        System.loadLibrary(<span class="hljs-string">"media_jni"</span>);
        native_init();
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">native_init</span><span class="hljs-params">()</span></span>;
    ...
}
</code></pre></div></div>

<p>通过static静态代码块中System.loadLibrary方法来加载动态库，库名为<code class="highlighter-rouge">media_jni</code>, Android平台则会自动扩展成所对应的<code class="highlighter-rouge">libmedia_jni.so</code>库。 接着通过关键字<code class="highlighter-rouge">native</code>加在native_init方法之前，便可以在java层直接使用native层方法。</p>

<p>接下来便要查看<code class="highlighter-rouge">libmedia_jni.so</code>库定义所在文件，一般都是通过<code class="highlighter-rouge">Android.mk</code>文件定义LOCAL_MODULE:= libmedia_jni，可以采用<a href="http://gityuan.com/2015/09/13/grep-and-find/">grep</a>或者<a href="http://gityuan.com/2016/03/19/android-build/#section-3">mgrep</a>来搜索包含libmedia_jni字段的Android.mk所在路径。</p>

<p>搜索可知，libmedia_jni.so位于/frameworks/base/media/jni/Android.mk。用前面实例(一)中的知识来查看相应的文件和方法名分别为：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs css"><span class="hljs-selector-tag">android_media_MediaPlayer</span><span class="hljs-selector-class">.cpp</span>
<span class="hljs-selector-tag">android_media_MediaPlayer_native_init</span>()
</code></pre></div></div>

<p>再然后，你会发现果然在该Android.mk所在目录<code class="highlighter-rouge">/frameworks/base/media/jni/</code>中找到android_media_MediaPlayer.cpp文件，并在文件中存在相应的方法：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs php">  <span class="hljs-keyword">static</span> void
android_media_MediaPlayer_native_init(JNIEnv *env)
{
    jclass clazz;
    clazz = env-&gt;FindClass(<span class="hljs-string">"android/media/MediaPlayer"</span>);
    fields.context = env-&gt;GetFieldID(clazz, <span class="hljs-string">"mNativeContext"</span>, <span class="hljs-string">"J"</span>);
    ...
}
</code></pre></div></div>

<p><strong>Tips：</strong>MediaPlayer.java中的native_init方法所对应的native方法位于<code class="highlighter-rouge">/frameworks/base/media/jni/</code>目录下的<code class="highlighter-rouge">android_media_MediaPlayer.cpp</code>文件中的<code class="highlighter-rouge">android_media_MediaPlayer_native_init</code>方法。</p>

<h3 id="23-小结">2.3 小结<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#23-%E5%B0%8F%E7%BB%93" aria-label="Anchor link for: 23 小结" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>

<p>JNI作为连接Java世界和C/C++世界的桥梁，很有必要掌握。看完本文，至少能掌握在分析Android源码过程中如何查找native方法。首先要明白native方法名和文件名的命名规律，其次要懂得该如何去搜索代码。</p>

<p>JNI注册的两种时机：</p>

<ul>
  <li>Android系统启动过程中Zygote注册，可通过查询AndroidRuntime.cpp中的gRegJNI，看看是否存在对应的register方法；</li>
  <li>调用System.loadLibrary()方式注册。</li>
</ul>

<h2 id="三-jni原理分析">三、 JNI原理分析<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#%E4%B8%89-jni%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90" aria-label="Anchor link for: 三 jni原理分析" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h2>

<p>再进一步来分析，Java层与Native层方法是如何注册并映射的，以MediaPlayer为例。
文件MediaPlayer.java中调用System.loadLibrary(“media_jni”)，把libmedia_jni.so动态库加载到内存。接下来，以loadLibrary为起点展开JNI注册流程的过程分析。</p>

<h3 id="31-loadlibrary">3.1 loadLibrary<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#31-loadlibrary" aria-label="Anchor link for: 31 loadlibrary" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>
<p>[System.java]</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loadLibrary</span><span class="hljs-params">(String libName)</span> </span>{
    <span class="hljs-comment">//调用Runtime方法</span>
    Runtime.getRuntime().loadLibrary(libName, VMStack.getCallingClassLoader());
}
</code></pre></div></div>

<p>[Runtime.java]</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs javascript"><span class="hljs-keyword">void</span> loadLibrary(<span class="hljs-built_in">String</span> libraryName, ClassLoader loader) {
    <span class="hljs-comment">//loader不会空，则进入该分支</span>
    <span class="hljs-keyword">if</span> (loader != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">//查找库所在路径</span>
        <span class="hljs-built_in">String</span> filename = loader.findLibrary(libraryName);
        <span class="hljs-comment">//加载库，见小节【3.2】</span>
        <span class="hljs-built_in">String</span> error = doLoad(filename, loader);
        <span class="hljs-keyword">if</span> (error != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsatisfiedLinkError(error);
        }
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">//loader为空，则会进入该分支</span>
    <span class="hljs-built_in">String</span> filename = System.mapLibraryName(libraryName);
    List&lt;<span class="hljs-built_in">String</span>&gt; candidates = <span class="hljs-keyword">new</span> ArrayList&lt;<span class="hljs-built_in">String</span>&gt;();
    <span class="hljs-built_in">String</span> lastError = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">String</span> directory : mLibPaths) {
        <span class="hljs-built_in">String</span> candidate = directory + filename;
        candidates.add(candidate);
        <span class="hljs-keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) {
             <span class="hljs-comment">//加载库，见小节【3.2】</span>
            <span class="hljs-built_in">String</span> error = doLoad(candidate, loader);
            <span class="hljs-keyword">if</span> (error == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span>;<span class="hljs-comment">//加载成功</span>
            }
            lastError = error;
        }
    }
    <span class="hljs-keyword">if</span> (lastError != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsatisfiedLinkError(lastError);
    }
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsatisfiedLinkError(<span class="hljs-string">"Library "</span> + libraryName + <span class="hljs-string">" not found; tried "</span> + candidates);
}
</code></pre></div></div>

<p>真正加载的工作是由doLoad()</p>

<h3 id="32-doload">3.2 doLoad<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#32-doload" aria-label="Anchor link for: 32 doload" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>

<p>该方法内部增加同步锁，保证并发时一致性。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">doLoad</span><span class="hljs-params">(String name, ClassLoader loader)</span> </span>{
    ...
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {
        <span class="hljs-keyword">return</span> nativeLoad(name, loader, ldLibraryPath);
    }
}
</code></pre></div></div>

<p>nativeLoad()这是一个native方法，再进入ART虚拟机的java_lang_Runtime.cc，再细讲就要深入剖析虚拟机内部，这里就不再往下深入了，这里直接说结论：</p>

<ul>
  <li>调用<code class="highlighter-rouge">dlopen</code>函数，打开一个so文件并创建一个handle；</li>
  <li>调用<code class="highlighter-rouge">dlsym()</code>函数，查看相应so文件的<code class="highlighter-rouge">JNI_OnLoad()</code>函数指针，并执行相应函数。</li>
</ul>

<p>总之，System.loadLibrary()的作用就是调用相应库中的JNI_OnLoad()方法。接下来说说JNI_OnLoad()过程。</p>

<h3 id="32-jni_onload">3.2 JNI_OnLoad<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#32-jni_onload" aria-label="Anchor link for: 32 jni_onload" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>
<p>[-&gt; android_media_MediaPlayer.cpp]</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs cpp"><span class="hljs-function">jint <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM* vm, <span class="hljs-keyword">void</span>* reserved)</span>
</span>{
    JNIEnv* env = <span class="hljs-literal">NULL</span>;
    <span class="hljs-comment">//【见3.3】 注册JNI方法</span>
    <span class="hljs-keyword">if</span> (register_android_media_MediaPlayer(env) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">goto</span> bail;
    }
    ...
}
</code></pre></div></div>

<h3 id="33-register_android_media_mediaplayer">3.3 register_android_media_MediaPlayer<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#33-register_android_media_mediaplayer" aria-label="Anchor link for: 33 register_android_media_mediaplayer" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>
<p>[-&gt; android_media_MediaPlayer.cpp]</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">register_android_media_MediaPlayer</span><span class="hljs-params">(JNIEnv *env)</span>
</span>{
    <span class="hljs-comment">//【见3.4】</span>
    <span class="hljs-keyword">return</span> AndroidRuntime::registerNativeMethods(env,
                <span class="hljs-string">"android/media/MediaPlayer"</span>, gMethods, NELEM(gMethods));
}
</code></pre></div></div>

<p>其中<code class="highlighter-rouge">gMethods</code>，记录java层和C/C++层方法的一一映射关系。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs objectivec"><span class="hljs-keyword">static</span> JNINativeMethod gMethods[] = {
    {<span class="hljs-string">"prepare"</span>,      <span class="hljs-string">"()V"</span>,  (<span class="hljs-keyword">void</span> *)android_media_MediaPlayer_prepare},
    {<span class="hljs-string">"_start"</span>,       <span class="hljs-string">"()V"</span>,  (<span class="hljs-keyword">void</span> *)android_media_MediaPlayer_start},
    {<span class="hljs-string">"_stop"</span>,        <span class="hljs-string">"()V"</span>,  (<span class="hljs-keyword">void</span> *)android_media_MediaPlayer_stop},
    {<span class="hljs-string">"seekTo"</span>,       <span class="hljs-string">"(I)V"</span>, (<span class="hljs-keyword">void</span> *)android_media_MediaPlayer_seekTo},
    {<span class="hljs-string">"_release"</span>,     <span class="hljs-string">"()V"</span>,  (<span class="hljs-keyword">void</span> *)android_media_MediaPlayer_release},
    {<span class="hljs-string">"native_init"</span>,  <span class="hljs-string">"()V"</span>,  (<span class="hljs-keyword">void</span> *)android_media_MediaPlayer_native_init},
    ...
};
</code></pre></div></div>

<p>这里涉及到结构体<code class="highlighter-rouge">JNINativeMethod</code>，其定义在<code class="highlighter-rouge">jni.h</code>文件：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs objectivec"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name;  <span class="hljs-comment">//Java层native函数名</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* signature; <span class="hljs-comment">//Java函数签名，记录参数类型和个数，以及返回值类型</span>
    <span class="hljs-keyword">void</span>*       fnPtr; <span class="hljs-comment">//Native层对应的函数指针</span>
} JNINativeMethod;
</code></pre></div></div>

<p>关于函数签名<code class="highlighter-rouge">signature</code>在下一小节展开说明。</p>

<h3 id="34-registernativemethods">3.4 registerNativeMethods<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#34-registernativemethods" aria-label="Anchor link for: 34 registernativemethods" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>
<p>[-&gt; AndroidRuntime.cpp]</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs objectivec"><span class="hljs-keyword">int</span> AndroidRuntime::registerNativeMethods(JNIEnv* env,
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* className, <span class="hljs-keyword">const</span> JNINativeMethod* gMethods, <span class="hljs-keyword">int</span> numMethods)
{
    <span class="hljs-comment">//【见3.5】</span>
    <span class="hljs-keyword">return</span> jniRegisterNativeMethods(env, className, gMethods, numMethods);
}
</code></pre></div></div>

<p>jniRegisterNativeMethods该方法是由Android JNI帮助类<code class="highlighter-rouge">JNIHelp.cpp</code>来完成。</p>

<h3 id="35-jniregisternativemethods">3.5 jniRegisterNativeMethods<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#35-jniregisternativemethods" aria-label="Anchor link for: 35 jniregisternativemethods" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>
<p>[-&gt; JNIHelp.cpp]</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">jniRegisterNativeMethods</span><span class="hljs-params">(C_JNIEnv* env, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* className,
    <span class="hljs-keyword">const</span> JNINativeMethod* gMethods, <span class="hljs-keyword">int</span> numMethods)</span>
</span>{
    JNIEnv* e = <span class="hljs-keyword">reinterpret_cast</span>&lt;JNIEnv*&gt;(env);
    scoped_local_ref&lt;jclass&gt; c(env, findClass(env, className));
    <span class="hljs-keyword">if</span> (c.get() == <span class="hljs-literal">NULL</span>) {
        e-&gt;FatalError(<span class="hljs-string">""</span>);<span class="hljs-comment">//无法查找native注册方法</span>
    }
    <span class="hljs-comment">//【见3.6】 调用JNIEnv结构体的成员变量</span>
    <span class="hljs-keyword">if</span> ((*env)-&gt;RegisterNatives(e, c.get(), gMethods, numMethods) &lt; <span class="hljs-number">0</span>) {
        e-&gt;FatalError(<span class="hljs-string">""</span>);<span class="hljs-comment">//native方法注册失败</span>
    }
    return <span class="hljs-number">0</span>;
}
</code></pre></div></div>

<h3 id="36-registernatives">3.6 RegisterNatives<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#36-registernatives" aria-label="Anchor link for: 36 registernatives" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>
<p>[-&gt; jni.h]</p>

<pre><code class="language-C hljs"><span class="hljs-keyword">struct</span> _JNIEnv {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> JNINativeInterface* functions;

    <span class="hljs-function">jint <span class="hljs-title">RegisterNatives</span><span class="hljs-params">(jclass clazz, <span class="hljs-keyword">const</span> JNINativeMethod* methods,
            jint nMethods)</span>
    </span>{ return functions-&gt;RegisterNatives(this, clazz, methods, nMethods); }
    ...
}
</code></pre>

<p>functions是指向<code class="highlighter-rouge">JNINativeInterface</code>结构体指针，也就是将调用下面方法：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code class="hljs objectivec"><span class="hljs-keyword">struct</span> JNINativeInterface {
    jint (*RegisterNatives)(JNIEnv*, jclass, <span class="hljs-keyword">const</span> JNINativeMethod*,jint);
    ...
}
</code></pre></div></div>

<p>再往下深入就到了虚拟机内部吧，这里就不再往下深入了。
总之，这个过程完成了<code class="highlighter-rouge">gMethods</code>数组中的方法的映射关系，比如java层的native_init()方法，映射到native层的android_media_MediaPlayer_native_init()方法。</p>

<p>虚拟机相关的变量中有两个非常重要的量JavaVM和JNIEnv:</p>

<ul>
  <li><code class="highlighter-rouge">JavaVM</code>：是指进程虚拟机环境，每个进程有且只有一个JavaVM实例</li>
  <li><code class="highlighter-rouge">JNIEnv</code>：是指线程上下文环境，每个线程有且只有一个JNIEnv实例，</li>
</ul>

<h2 id="四jni资源">四、JNI资源<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#%E5%9B%9Bjni%E8%B5%84%E6%BA%90" aria-label="Anchor link for: 四jni资源" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h2>

<p>JNINativeMethod结构体中有一个字段为signature(签名)，再介绍signature格式之前需要掌握各种数据类型在Java层、Native层以及签名所采用的签名格式。</p>

<h3 id="41-数据签名">4.1 数据签名<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#41-%E6%95%B0%E6%8D%AE%E7%AD%BE%E5%90%8D" aria-label="Anchor link for: 41 数据签名" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>

<h4 id="411-基本数据类型">4.1.1 基本数据类型<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#411-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-label="Anchor link for: 411 基本数据类型" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h4>

<div class="table-responsive"><table class="table">
  <thead>
    <tr>
      <th>Signature格式</th>
      <th>Java</th>
      <th>Native</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>B</td>
      <td>byte</td>
      <td>jbyte</td>
    </tr>
    <tr>
      <td>C</td>
      <td>char</td>
      <td>jchar</td>
    </tr>
    <tr>
      <td>D</td>
      <td>double</td>
      <td>jdouble</td>
    </tr>
    <tr>
      <td>F</td>
      <td>float</td>
      <td>jfloat</td>
    </tr>
    <tr>
      <td>I</td>
      <td>int</td>
      <td>jint</td>
    </tr>
    <tr>
      <td>S</td>
      <td>short</td>
      <td>jshort</td>
    </tr>
    <tr>
      <td>J</td>
      <td>long</td>
      <td>jlong</td>
    </tr>
    <tr>
      <td>Z</td>
      <td>boolean</td>
      <td>jboolean</td>
    </tr>
    <tr>
      <td>V</td>
      <td>void</td>
      <td>void</td>
    </tr>
  </tbody>
</table></div>

<h4 id="412-数组数据类型">4.1.2 数组数据类型<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#412-%E6%95%B0%E7%BB%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-label="Anchor link for: 412 数组数据类型" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h4>

<p>数组简称则是在前面添加<code class="highlighter-rouge">[</code>：</p>

<div class="table-responsive"><table class="table">
  <thead>
    <tr>
      <th>Signature格式</th>
      <th>Java</th>
      <th>Native</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>[B</td>
      <td>byte[]</td>
      <td>jbyteArray</td>
    </tr>
    <tr>
      <td>[C</td>
      <td>char[]</td>
      <td>jcharArray</td>
    </tr>
    <tr>
      <td>[D</td>
      <td>double[]</td>
      <td>jdoubleArray</td>
    </tr>
    <tr>
      <td>[F</td>
      <td>float[]</td>
      <td>jfloatArray</td>
    </tr>
    <tr>
      <td>[I</td>
      <td>int[]</td>
      <td>jintArray</td>
    </tr>
    <tr>
      <td>[S</td>
      <td>short[]</td>
      <td>jshortArray</td>
    </tr>
    <tr>
      <td>[J</td>
      <td>long[]</td>
      <td>jlongArray</td>
    </tr>
    <tr>
      <td>[Z</td>
      <td>boolean[]</td>
      <td>jbooleanArray</td>
    </tr>
  </tbody>
</table></div>

<h4 id="413-复杂数据类型">4.1.3 复杂数据类型<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#413-%E5%A4%8D%E6%9D%82%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-label="Anchor link for: 413 复杂数据类型" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h4>

<p>对象类型简称：<code class="highlighter-rouge">L+classname +;</code></p>

<div class="table-responsive"><table class="table">
  <thead>
    <tr>
      <th>Signature格式</th>
      <th>Java</th>
      <th>Native</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Ljava/lang/String;</td>
      <td>String</td>
      <td>jstring</td>
    </tr>
    <tr>
      <td>L+classname +;</td>
      <td>所有对象</td>
      <td>jobject</td>
    </tr>
    <tr>
      <td>[L+classname +;</td>
      <td>Object[]</td>
      <td>jobjectArray</td>
    </tr>
    <tr>
      <td>Ljava.lang.Class;</td>
      <td>Class</td>
      <td>jclass</td>
    </tr>
    <tr>
      <td>Ljava.lang.Throwable;</td>
      <td>Throwable</td>
      <td>jthrowable</td>
    </tr>
  </tbody>
</table></div>

<h4 id="414-signature">4.1.4 Signature<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#414-signature" aria-label="Anchor link for: 414 signature" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h4>

<p>有了前面的铺垫，那么再来通过实例说说函数签名： <code class="highlighter-rouge">(输入参数...)返回值参数</code>，这里用到的便是前面介绍的Signature格式。</p>

<div class="table-responsive"><table class="table">
  <thead>
    <tr>
      <th>Java函数</th>
      <th>对应的签名</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>void foo()</td>
      <td>()V</td>
    </tr>
    <tr>
      <td>float foo(int i)</td>
      <td>(I)F</td>
    </tr>
    <tr>
      <td>long foo(int[] i)</td>
      <td>([I)J</td>
    </tr>
    <tr>
      <td>double foo(Class c)</td>
      <td>(Ljava/lang/Class;)D</td>
    </tr>
    <tr>
      <td>boolean foo(int[] i,String s)</td>
      <td>([ILjava/lang/String;)Z</td>
    </tr>
    <tr>
      <td>String foo(int i)</td>
      <td>(I)Ljava/lang/String;</td>
    </tr>
  </tbody>
</table></div>

<h3 id="42-其他">4.2 其他<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#42-%E5%85%B6%E4%BB%96" aria-label="Anchor link for: 42 其他" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h3>

<p><strong>(一)垃圾回收</strong>
对于Java开发人员来说无需关系垃圾回收，完全由虚拟机GC来负责垃圾回收，而对于JNI开发人员，对于内存释放需要谨慎处理，需要的时候申请，使用完记得释放内容，以免发生内存泄露。在JNI提供了三种Reference类型，Local Reference(本地引用)， Global Reference（全局引用）， Weak Global Reference(全局弱引用)。其中Global Reference如果不主动释放，则一直不会释放；对于其他两个类型的引用都是释放的可能性，那是不是意味着不需要手动释放呢？答案是否定的，不管是这三种类型的那种引用，都尽可能在某个内存不再需要时，立即释放，这对系统更为安全可靠，以减少不可预知的性能与稳定性问题。</p>

<p>另外，ART虚拟机在GC算法有所优化，为了减少内存碎片化问题，在GC之后有可能会移动对象内存的位置，对于Java层程序并没有影响，但是对于JNI程序可要小心了，对于通过指针来直接访问内存对象是，Dalvik能正确运行的程序，ART下未必能正常运行。</p>

<p><strong>(二)异常处理</strong>
Java层出现异常，虚拟机会直接抛出异常，这是需要try..catch或者继续往外throw。但是对于JNI出现异常时，即执行到JNIEnv中某个函数异常时，并不会立即抛出异常来中断程序的执行，还可以继续执行内存之类的清理工作，直到返回到Java层时才会抛出相应的异常。</p>

<p>另外，<code class="highlighter-rouge">Dalvik</code>虚拟机有些情况下JNI函数出错可能返回NULL，但<code class="highlighter-rouge">ART</code>虚拟机在出错时更多的是抛出异常。这样导致的问题就可能是在Dalvik版本能正常运行的程序，在ART虚拟机上由于没有正确处理异常而崩溃。</p>

<h2 id="总结">总结<a class="anchorjs-link " href="http://gityuan.com/2016/05/28/android-jni/#%E6%80%BB%E7%BB%93" aria-label="Anchor link for: 总结" data-anchorjs-icon="#" style="opacity: 1; padding-left: 0.375em;"></a></h2>

<p>本文主要通过实例，基于Android 6.0源码来分析JNI原理，讲述JNI核心功能：</p>

<ul>
  <li>介绍了如何查找JNI方法，让大家明白如何从Java层跳转到Native层；</li>
  <li>分析了JNI函数注册流程，进一步加深对JNI的理解；</li>
  <li>列举Java与native以及函数签名方式。</li>
</ul>

<p><strong>jni存在的常见目录：</strong></p>

<ul>
  <li><code class="highlighter-rouge">/framework/base/core/jni/</code></li>
  <li><code class="highlighter-rouge">/framework/base/services/core/jni/</code></li>
  <li><code class="highlighter-rouge">/framework/base/media/jni/</code></li>
</ul>

								<hr>
								<a target="_blank" href="http://weibo.com/gityuan">
	<font color="#f57e42" data-darkreader-inline-color="" style="--darkreader-inline-color:#ad8067;"><strong>weibo.com/gityuan</strong></font>
</a>
<font color="#004B97" data-darkreader-inline-color="" style="--darkreader-inline-color:#93acbe;"><strong>微博关注  |  </strong></font>

<a target="_blank" href="http://gityuan.com/talk/">
	<font color="#f57e42" data-darkreader-inline-color="" style="--darkreader-inline-color:#ad8067;"><strong>留言区</strong></font>
</a>
<font color="#004B97" data-darkreader-inline-color="" style="--darkreader-inline-color:#93acbe;"><strong>技术交流  |  </strong></font>
<a target="_blank" href="http://gityuan.com/images/about-me/gityuan_pay.jpg">
	<font color="#f57e42" data-darkreader-inline-color="" style="--darkreader-inline-color:#ad8067;"><strong>¥打赏支持</strong></font>
</a>

                <hr>
								

                <ul class="pager">
                    
                    <li class="previous">
                        <a target="_blank" href="http://gityuan.com/2016/05/21/syscall/" data-toggle="tooltip" data-placement="top" title="Linux系统调用(syscall)原理">
                        上一篇<br>
                        <span>Linux系统调用(syscall)原理</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a target="_blank" href="http://gityuan.com/2016/06/04/broadcast-receiver/" data-toggle="tooltip" data-placement="top" title="Android Broadcast广播机制分析">
                        下一篇<br>
                        <span>Android Broadcast广播机制分析</span>
                        </a>
                    </li>
                    
                </ul>


                

            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog fixed">
                    <hr class="hidden-sm hidden-xs">
                    <h5 id="catalog">
                        <a class="catalog-toggle" href="http://gityuan.com/2016/05/28/android-jni/#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"><li class="h2_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#%E4%B8%80jni%E6%A6%82%E8%BF%B0" rel="nofollow">一、JNI概述</a></li><li class="h2_nav active"><a href="http://gityuan.com/2016/05/28/android-jni/#%E4%BA%8Cjni%E6%9F%A5%E6%89%BE%E6%96%B9%E5%BC%8F" rel="nofollow">二、JNI查找方式</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#21-startreg" rel="nofollow">2.1 startReg</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#22-%E5%A6%82%E4%BD%95%E6%9F%A5%E6%89%BEnative%E6%96%B9%E6%B3%95" rel="nofollow">2.2 如何查找native方法</a></li><li class="h4_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#221-%E5%AE%9E%E4%BE%8B%E4%B8%80" rel="nofollow">2.2.1 实例(一)</a></li><li class="h4_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#222-%E5%AE%9E%E4%BE%8B%E4%BA%8C" rel="nofollow">2.2.2 实例(二)</a></li><li class="h4_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#223-%E5%AE%9E%E4%BE%8B%E4%B8%89" rel="nofollow">2.2.3 实例(三)</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#23-%E5%B0%8F%E7%BB%93" rel="nofollow">2.3 小结</a></li><li class="h2_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#%E4%B8%89-jni%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90" rel="nofollow">三、 JNI原理分析</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#31-loadlibrary" rel="nofollow">3.1 loadLibrary</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#32-doload" rel="nofollow">3.2 doLoad</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#32-jni_onload" rel="nofollow">3.2 JNI_OnLoad</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#33-register_android_media_mediaplayer" rel="nofollow">3.3 register_android_media_MediaPlayer</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#34-registernativemethods" rel="nofollow">3.4 registerNativeMethods</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#35-jniregisternativemethods" rel="nofollow">3.5 jniRegisterNativeMethods</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#36-registernatives" rel="nofollow">3.6 RegisterNatives</a></li><li class="h2_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#%E5%9B%9Bjni%E8%B5%84%E6%BA%90" rel="nofollow">四、JNI资源</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#41-%E6%95%B0%E6%8D%AE%E7%AD%BE%E5%90%8D" rel="nofollow">4.1 数据签名</a></li><li class="h4_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#411-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" rel="nofollow">4.1.1 基本数据类型</a></li><li class="h4_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#412-%E6%95%B0%E7%BB%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" rel="nofollow">4.1.2 数组数据类型</a></li><li class="h4_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#413-%E5%A4%8D%E6%9D%82%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" rel="nofollow">4.1.3 复杂数据类型</a></li><li class="h4_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#414-signature" rel="nofollow">4.1.4 Signature</a></li><li class="h3_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#42-%E5%85%B6%E4%BB%96" rel="nofollow">4.2 其他</a></li><li class="h2_nav"><a href="http://gityuan.com/2016/05/28/android-jni/#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></li></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5 id="-1"><a target="_blank" href="http://gityuan.com/tags/">标签</a></h5>
                    <div class="tags">
                      
                            <a target="_blank" href="http://gityuan.com/tags/#android" title="android" rel="152">
                                    android
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E7%BB%84%E4%BB%B6%E7%B3%BB%E5%88%97" title="组件系列" rel="19">
                                    组件系列
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#else" title="else" rel="3">
                                    else
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#debug" title="debug" rel="19">
                                    debug
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E6%9D%83%E9%99%90" title="权限" rel="2">
                                    权限
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#web" title="web" rel="2">
                                    web
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#tool" title="tool" rel="12">
                                    tool
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#java" title="java" rel="12">
                                    java
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#performance" title="performance" rel="4">
                                    performance
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#app" title="app" rel="2">
                                    app
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#algorithm" title="algorithm" rel="1">
                                    algorithm
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E8%BF%9B%E7%A8%8B%E7%B3%BB%E5%88%97" title="进程系列" rel="13">
                                    进程系列
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E8%99%9A%E6%8B%9F%E6%9C%BA" title="虚拟机" rel="1">
                                    虚拟机
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#memory" title="memory" rel="5">
                                    memory
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#jvm" title="jvm" rel="5">
                                    jvm
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#linux" title="linux" rel="11">
                                    linux
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#binder" title="binder" rel="19">
                                    binder
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#ipc" title="ipc" rel="3">
                                    ipc
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#handler" title="handler" rel="3">
                                    handler
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#process" title="process" rel="6">
                                    process
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#power" title="power" rel="1">
                                    power
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8" title="系统启动" rel="6">
                                    系统启动
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#AMS" title="AMS" rel="2">
                                    AMS
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#PMS" title="PMS" rel="1">
                                    PMS
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E8%87%AA%E5%AD%A6%E7%BC%96%E7%A8%8B" title="自学编程" rel="1">
                                    自学编程
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#stability" title="stability" rel="8">
                                    stability
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E7%BB%84%E4%BB%B6" title="组件" rel="3">
                                    组件
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#art" title="art" rel="2">
                                    art
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#graphic" title="graphic" rel="1">
                                    graphic
                            </a>
                      
                            <a target="_blank" href="http://gityuan.com/tags/#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B" title="实战案例" rel="7">
                                    实战案例
                            </a>
                      
                    </div>
                </section> 
                 

                <!-- Friends Blog -->
                <!-- 
                 -->
            </div>
        </div>
    </div>
</article>






<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style><style class="darkreader darkreader--sync" media="screen"></style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/gityuan">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/gityuan">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
										
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/gityuan">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://gityuan.com/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright © Gityuan  2019 | Powered by Jekyll with Hux Theme
                </p>
                <!-- 流量统计 -->
								<div style="display:none">
                                    <!--
									<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1000098804'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1000098804%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>-->
                                    
                                    <!-- Baidu Tongji -->
                                    <script>
                                    var _hmt = _hmt || [];
                                    (function() {
                                      var hm = document.createElement("script");
                                      hm.src = "https://hm.baidu.com/hm.js?3b1c71bfd9641a47009f87240c135d75";
                                      var s = document.getElementsByTagName("script")[0]; 
                                      s.parentNode.insertBefore(hm, s);
                                    })();
                                    </script>
								</div>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/jquery.min.js.download"></script>

<!-- Bootstrap Core JavaScript -->
<script src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/bootstrap.min.js.download"></script>

<!-- Custom Theme JavaScript -->
<script src="./Android JNI原理分析 - Gityuan博客 _ 袁辉辉的Android博客_files/hux-blog.min.js.download"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body></html>